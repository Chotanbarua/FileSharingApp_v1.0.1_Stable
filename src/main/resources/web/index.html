<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Sharing App - Web UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fb;
            margin: 0;
        }
        .wrapper {
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h1 {
            margin-top: 0;
            color: #1f6feb;
            font-weight: 600;
        }
        label {
            display: block;
            margin-top: 14px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 9px;
            margin-top: 4px;
            border-radius: 6px;
            border: 1px solid #ccd4e0;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            margin-top: 18px;
            padding: 10px 20px;
            background: #1f6feb;
            color: #fff;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        button:hover {
            background: #144a9b;
        }
        .small {
            font-size: 12px;
            color: #666;
        }
        .ip-box {
            padding: 10px 12px;
            background: #f0f4ff;
            border-radius: 8px;
            margin-bottom: 18px;
            font-size: 14px;
        }
        #status {
            margin-top: 10px;
            min-height: 18px;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <h1 tabindex="0">üìÅ File Sharing App - Web UI</h1>

    <div class="ip-box">
        <div>
            Your IP (share this with your partner):
            <strong><span id="userIP">localhost</span></strong>
        </div>
        <div class="small">
            If you're on the same Wi-Fi, share this IP with your partner.
            For remote transfers, agree on HTTP URL, ZeroTier Network ID, or S3 details.
        </div>
    </div>

    <!-- Main form -->
    <form id="transferForm">
        <label for="name">Your Name</label>
        <input id="name" type="text" placeholder="Enter your name"/>

        <label for="role">Role</label>
        <select id="role">
            <option value="Sender">Sender</option>
            <option value="Receiver">Receiver</option>
        </select>

        <label for="method">Transfer Method</label>
        <select id="method">
            <option value="HTTP">HTTP (Simple / LAN)</option>
            <option value="ZeroTier">ZeroTier (Secure P2P)</option>
            <option value="S3">AWS S3 (Cloud)</option>
        </select>

        <!-- This label is dynamic based on role -->
        <label for="file" id="fileLabel">File (Sender only)</label>
        <input id="file" type="file"/>

        <label for="target">
            Target IP / URL / Bucket
        </label>
        <input id="target" type="text"
               placeholder="HTTP: Receiver IP or http://host:port
ZeroTier: 16-digit Network ID
S3: Bucket name or presigned URL"/>

        <div class="small">
            HTTP ‚ûú Receiver's IP / URL for the upload.<br/>
            ZeroTier ‚ûú Your shared ZeroTier Network ID (16-digit hex).<br/>
            S3 ‚ûú S3 bucket name or presigned upload URL used by both sides.
        </div>

        <label for="port">Port</label>
        <input id="port" type="text" value="8080"/>

        <button id="startBtn" type="submit">
            <span>üöÄ</span><span>Start</span>
        </button>
    </form>

    <!-- Status / helper prompts -->
    <div id="status" class="small" aria-live="polite"></div>
</div>

<script>
    // --- Detect & display user's IP (best-effort) ---
    (function detectLocalIP() {
        const ipEl = document.getElementById('userIP');
        // Try public IP first
        fetch('https://api.ipify.org?format=json')
            .then(r => r.json())
            .then(d => {
                if (d && d.ip) {
                    ipEl.textContent = d.ip;
                } else {
                    ipEl.textContent = location.hostname || 'localhost';
                }
            })
            .catch(() => {
                ipEl.textContent = location.hostname || 'localhost';
            });
    })();

    // --- Form behavior & validation ---
    (function () {
        const form     = document.getElementById('transferForm');
        const roleEl   = document.getElementById('role');
        const methodEl = document.getElementById('method');
        const targetEl = document.getElementById('target');
        const nameEl   = document.getElementById('name');
        const fileEl   = document.getElementById('file');
        const fileLabel = document.getElementById('fileLabel');
        const statusEl = document.getElementById('status');

        // Dynamic label + simple UX toggle
        function updateRoleView() {
            const role = roleEl.value;
            if (role === 'Sender') {
                fileLabel.textContent = 'File (Sender only)';
                fileEl.disabled = false;
            } else {
                fileLabel.textContent = 'Save Location (Receiver)';
                // Receiver doesn‚Äôt choose a file in browser UI
                fileEl.value = '';
                fileEl.disabled = true;
            }
        }

        roleEl.addEventListener('change', updateRoleView);
        updateRoleView(); // initial

        form.addEventListener('submit', function (e) {
            statusEl.textContent = '';

            const role   = roleEl.value;
            const method = methodEl.value;
            const target = targetEl.value.trim();

            // 1) Require name
            if (!nameEl.value.trim()) {
                e.preventDefault();
                statusEl.textContent = "Please tell me your name üòä";
                return;
            }

            // 2) Sender must pick a file
            if (role === 'Sender' && !fileEl.files.length) {
                e.preventDefault();
                statusEl.textContent = "You did not pick any file. Please select at least one file.";
                return;
            }

            // 3) ZeroTier-specific validation (critical prompt)
            if (role === 'Sender' && method === 'ZeroTier') {
                const networkId = target;
                const validZT = /^[0-9a-f]{16}$/i.test(networkId);
                if (!validZT) {
                    e.preventDefault();
                    statusEl.textContent =
                        "‚ö†Ô∏è Invalid ZeroTier Network ID. It should be a 16-digit hexadecimal (e.g., abcd1234ef567890).";
                    return;
                }
            }

            // 4) Sender + real transport => target required
            const needsTarget =
                role === 'Sender' &&
                (method === 'HTTP' || method === 'ZeroTier' || method === 'S3');

            if (needsTarget && !target) {
                e.preventDefault();
                statusEl.textContent =
                    "Please enter the Receiver IP / URL / Bucket before starting üö¶";
                return;
            }

            // 5) Friendly footer AFTER valid input
            if (role === 'Receiver') {
                statusEl.textContent =
                    "Hi friend üëã You‚Äôre in Receiver mode. Keep this page open and start the transfer from the desktop app.";
            } else {
                statusEl.textContent =
                    "Awesome üöÄ Preparing your transfer. Continue in the desktop app to complete the send.";
            }

            // NOTE:
            // This Web UI is a companion front-end. It currently does not
            // POST the file; the desktop/Java side reads these details or
            // uses them for guidance.
            e.preventDefault();
        });

        // Optional: listen to /prompt so backend can push live messages here
        function pollPrompt() {
            fetch('/prompt')
                .then(r => r.text())
                .then(text => {
                    if (text && text !== 'OK') {
                        statusEl.textContent = text;
                    }
                })
                .catch(() => {/* ignore */})
                .finally(() => {
                    setTimeout(pollPrompt, 2000);
                });
        }
        // Uncomment when your backend /prompt endpoint is active:
        // pollPrompt();
    })();
</script>
</body>
</html>
